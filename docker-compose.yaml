services:
  # THE DATABASE
  db:
    image: mongo:7
    container_name: mongodb
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_APP_PASSWORD=${MONGO_APP_PASSWORD}
    volumes:
      - mongo-data:/data/db
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - blog-network

  # SECRETS MANAGER
  vault:
    image: hashicorp/vault:1.16
    container_name: vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK          # Prevents Vault secrets from being swapped to disk
    environment:
      VAULT_LOCAL_CONFIG: >
        {
          "storage": { "file": { "path": "/vault/data" } },
          "listener": [{ "tcp": { "address": "0.0.0.0:8200", "tls_disable": true } }],
          "default_lease_ttl": "1h",
          "max_lease_ttl": "4h",
          "ui": false,
          "log_level": "warn"
        }
    command: server
    volumes:
      - vault-data:/vault/data
      - vault-audit:/vault/audit
    expose:
      - "8200"            # Internal only â€” not exposed to host
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8200/v1/sys/init || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - blog-network

  # THE BACKEND API
  app:
    image: ${API_DIGEST}
    container_name: api_container
    restart: unless-stopped
    expose:
      - "4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - MONGO_URI=mongodb://blogapi:${MONGO_APP_PASSWORD}@db:27017/blog?authSource=blog
      - JWT_SECRET=${JWT_SECRET}
      - VAULT_ADDR=http://vault:8200
      - VAULT_ROLE_ID=${VAULT_ROLE_ID}
      - VAULT_SECRET_ID=${VAULT_SECRET_ID}
      - CORS_ORIGIN=${CORS_ORIGIN}
    depends_on:
      - db
      - vault
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:4000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - blog-network

  # THE FRONTEND
  myblog:
    image: ${FRONTEND_DIGEST}
    container_name: myblog_container
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - app
    networks:
      - blog-network

volumes:
  mongo-data:
  vault-data:             # Persists Vault's initialized+sealed state across restarts
  vault-audit:            # Persists Vault audit logs

networks:
  blog-network:
    driver: bridge
