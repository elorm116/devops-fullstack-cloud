name: Cleanup Old Docker Hub Tags

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

env:
  DOCKERHUB_USER: elorm116

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete sha- tags older than 7 days
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          # 1. Authenticate
          LOGIN_RES=$(curl -sf -X POST https://hub.docker.com/v2/users/login/ \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"$DOCKERHUB_USER\", \"password\": \"$DOCKERHUB_TOKEN\"}")
          
          AUTH=$(echo "$LOGIN_RES" | python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")
          CUTOFF=$(python3 -c "import time; print(int(time.time()) - 7 * 86400)")

          for REPO in myjs-app myreact-app; do
            echo "── Cleaning $DOCKERHUB_USER/$REPO ──"

            # 2. Fetch tags
            TAGS_JSON=$(curl -sf -H "Authorization: JWT $AUTH" \
              "https://hub.docker.com/v2/repositories/$DOCKERHUB_USER/$REPO/tags?page_size=100")
            
            TAGS=$(echo "$TAGS_JSON" | python3 -c "import sys,json; results = json.load(sys.stdin).get('results', []); [print(t['name']+'|'+t['last_updated']) for t in results]")

            if [ -z "$TAGS" ]; then
              echo "  No tags found."
              continue
            fi

            # 3. Loop through tags
            echo "$TAGS" | while IFS='|' read -r NAME UPDATED; do
              [ -z "$NAME" ] && continue

              if [[ ! "$NAME" =~ ^sha- ]]; then
                echo "  Skipping $NAME (protected)"
                continue
              fi

              # Fixed Python block: Removed internal multiline to keep YAML happy
              UPDATED_TS=$(python3 -c "import datetime, sys; s=sys.argv[1].replace('Z', '+0000'); print(int(datetime.datetime.fromisoformat(s).timestamp()))" "$UPDATED")

              if [ "$UPDATED_TS" -lt "$CUTOFF" ]; then
                echo "  Deleting $NAME (last updated $UPDATED)"
                curl -sf -X DELETE -H "Authorization: JWT $AUTH" \
                  "https://hub.docker.com/v2/repositories/$DOCKERHUB_USER/$REPO/tags/$NAME/" \
                  && echo "  ✅ Deleted $NAME" || echo "  ⚠️  Failed to delete $NAME"
              else
                echo "  Keeping $NAME (recent)"
              fi
            done
            echo ""
            echo "✅ Cleanup complete for $REPO"
          done
          