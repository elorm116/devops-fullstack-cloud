name: Rotate Vault AppRole Secret ID

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type ROTATE to confirm"
        required: true

env:
  SERVER_HOST: nam.taild248f7.ts.net
  SERVER_USER: nam
  SERVER_DIR: ~/dockerize
  GITHUB_REPO: elorm116/devops-fullstack-cloud

jobs:
  rotate:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'ROTATE'

    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup SSH
        env:
          SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SERVER_FINGERPRINT: ${{ secrets.SERVER_FINGERPRINT }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$SERVER_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "$SERVER_FINGERPRINT" >> ~/.ssh/known_hosts

      - name: Generate new Secret ID on server
        id: generate-secret
        env:
          VAULT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          NEW_SECRET_ID=$(ssh -i ~/.ssh/id_ed25519 "${SERVER_USER}@${SERVER_HOST}" \
            VAULT_TOKEN="$VAULT_TOKEN" \
            bash -c '
              set -euo pipefail

              RESPONSE=$(curl --silent --fail \
                --header "X-Vault-Token: $VAULT_TOKEN" \
                --request POST --data "{}" \
                http://127.0.0.1:8200/v1/auth/approle/role/myjs-app/secret-id)

              NEW_SECRET_ID=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin)[\"data\"][\"secret_id\"])")

              if [[ -z "$NEW_SECRET_ID" ]]; then
                echo "Failed to generate new Secret ID" >&2
                exit 1
              fi

              echo "$NEW_SECRET_ID"
            ')

          # Mask before anything else so it never appears in logs
          echo "::add-mask::$NEW_SECRET_ID"
          echo "new_secret_id=$NEW_SECRET_ID" >> "$GITHUB_OUTPUT"

      - name: Update VAULT_SECRET_ID in GitHub secrets
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          NEW_SECRET_ID: ${{ steps.generate-secret.outputs.new_secret_id }}
        shell: bash
        run: |
          set -euo pipefail

          pip install PyNaCl --quiet >/dev/null

          PUB_KEY_RESPONSE=$(curl --silent --fail \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GITHUB_REPO}/actions/secrets/public-key")

          KEY_ID=$(echo "$PUB_KEY_RESPONSE" | python3 -c 'import sys,json; print(json.load(sys.stdin)["key_id"])')
          PUB_KEY=$(echo "$PUB_KEY_RESPONSE" | python3 -c 'import sys,json; print(json.load(sys.stdin)["key"])')

          ENCRYPTED=$(PUB_KEY="$PUB_KEY" NEW_SECRET_ID="$NEW_SECRET_ID" python3 -c "
          import base64, os
          from nacl import encoding, public
          pk = public.PublicKey(base64.b64decode(os.environ['PUB_KEY']))
          box = public.SealedBox(pk)
          enc = box.encrypt(os.environ['NEW_SECRET_ID'].encode())
          print(base64.b64encode(enc).decode())
          ")

          HTTP_STATUS=$(curl --silent --output /dev/null --write-out "%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"encrypted_value\":\"$ENCRYPTED\",\"key_id\":\"$KEY_ID\"}" \
            "https://api.github.com/repos/${GITHUB_REPO}/actions/secrets/VAULT_SECRET_ID")

          if [[ "$HTTP_STATUS" =~ ^(201|204)$ ]]; then
            echo "VAULT_SECRET_ID updated successfully"
            exit 0
          else
            echo "Failed to update GitHub secret â†’ HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Revoke old Secret ID on server
        env:
          VAULT_TOKEN: ${{ secrets.VAULT_ROOT_TOKEN }}
          OLD_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
        shell: bash
        run: |
          ssh -i ~/.ssh/id_ed25519 "${SERVER_USER}@${SERVER_HOST}" \
            VAULT_TOKEN="$VAULT_TOKEN" \
            OLD_SECRET_ID="$OLD_SECRET_ID" \
            bash -c '
              set -euo pipefail
              curl --silent --fail \
                --header "X-Vault-Token: $VAULT_TOKEN" \
                --request POST \
                --data "{\"secret_id\":\"$OLD_SECRET_ID\"}" \
                http://127.0.0.1:8200/v1/auth/approle/role/myjs-app/secret-id/destroy \
                || true
              echo "Old Secret ID revocation attempted"
            '

      - name: Trigger redeploy
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        shell: bash
        run: |
          HTTP_STATUS=$(curl --silent --output /dev/null --write-out "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{"ref":"main"}' \
            "https://api.github.com/repos/${GITHUB_REPO}/actions/workflows/deploy-server.yml/dispatches")

          if [[ "$HTTP_STATUS" == "204" ]]; then
            echo "Redeploy triggered successfully"
          else
            echo "Could not trigger redeploy (HTTP $HTTP_STATUS) â€” trigger manually"
            exit 0
          fi

      - name: Rotation Summary
        if: always()
        shell: bash
        run: |
          echo "## ðŸ” Vault AppRole Secret ID Rotation" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "| Step                              | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------------------------------|--------|" >> "$GITHUB_STEP_SUMMARY"

          if [[ "${{ steps.generate-secret.outcome }}" == "success" ]]; then
            echo "| New Secret ID generated           | âœ…     |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| New Secret ID generated           | âŒ     |" >> "$GITHUB_STEP_SUMMARY"
          fi

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "| GitHub secret updated             | âœ…     |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Old Secret ID revoked             | âœ…     |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Redeploy triggered                | âœ…     |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| GitHub secret updated             | âš ï¸ / âŒ |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Old Secret ID revoked             | âš ï¸ / âŒ |" >> "$GITHUB_STEP_SUMMARY"
            echo "| Redeploy triggered                | âš ï¸      |" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_STEP_SUMMARY"